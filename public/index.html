<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AllCampus Email Generator - Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      color: #1a73e8;
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    
    .input-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    
    .input-group {
      display: flex;
      gap: 12px;
    }
    
    input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input[type="text"]:focus {
      border-color: #1a73e8;
    }
    
    button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #1557b0;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .contact-info {
      background: #e8f0fe;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: none;
    }
    
    .contact-info.visible {
      display: block;
    }
    
    .contact-info h3 {
      color: #1a73e8;
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .contact-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .contact-detail {
      font-size: 14px;
    }
    
    .contact-detail label {
      color: #666;
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
    }
    
    .persona-badge {
      display: inline-block;
      background: #1a73e8;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .style-badge {
      display: inline-block;
      background: #7c4dff;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .research-section {
      background: #e8f5e9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: none;
    }
    
    .research-section.visible {
      display: block;
    }
    
    .research-section h3 {
      color: #2e7d32;
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .research-content {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .research-stats {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    .stat-box {
      background: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #2e7d32;
    }
    
    .stat-value.negative {
      color: #c62828;
    }
    
    .stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
    }
    
    .program-list {
      margin-top: 12px;
      font-size: 13px;
    }
    
    .program-item {
      display: inline-block;
      background: white;
      padding: 4px 10px;
      border-radius: 4px;
      margin: 2px 4px 2px 0;
    }
    
    .program-growing {
      color: #2e7d32;
    }
    
    .program-declining {
      color: #c62828;
    }
    
    .prospect-research-section {
      background: #fff3e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: none;
    }
    
    .prospect-research-section.visible {
      display: block;
    }
    
    .prospect-research-section h3 {
      color: #e65100;
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .prospect-section {
      margin-bottom: 12px;
    }
    
    .prospect-section-title {
      font-weight: 600;
      color: #e65100;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    
    .prospect-section-content {
      font-size: 14px;
      line-height: 1.5;
    }
    
    .prospect-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .badge-high {
      background: #c8e6c9;
      color: #2e7d32;
    }
    
    .badge-medium {
      background: #fff3e0;
      color: #e65100;
    }
    
    .badge-low {
      background: #ffcdd2;
      color: #c62828;
    }
    
    .prospect-sections ul {
      margin: 4px 0 0 20px;
      padding: 0;
    }
    
    .prospect-sections li {
      margin-bottom: 4px;
    }
    
    .emails-section {
      display: none;
    }
    
    .emails-section.visible {
      display: block;
    }
    
    .email-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .email-header {
      background: #f8f9fa;
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .email-number {
      font-size: 12px;
      font-weight: 600;
      color: #1a73e8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .email-subject {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .email-body {
      padding: 20px;
      font-size: 15px;
      color: #444;
    }
    
    .email-body p {
      margin-bottom: 12px;
    }
    
    .email-body p:last-child {
      margin-bottom: 0;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      display: none;
    }
    
    .loading.visible {
      display: block;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error {
      background: #fce8e6;
      color: #c5221f;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .error.visible {
      display: block;
    }
    
    .copy-btn {
      background: #f1f3f4;
      color: #333;
      padding: 6px 12px;
      font-size: 12px;
      margin-left: 12px;
    }
    
    .copy-btn:hover {
      background: #e0e0e0;
    }
    
    .note {
      text-align: center;
      color: #666;
      font-size: 13px;
      margin-top: 20px;
      padding: 12px;
      background: #fff3cd;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>AllCampus Email Generator</h1>
      <p class="subtitle">Preview generated emails for a HubSpot contact (nothing is saved)</p>
    </header>
    
    <div class="input-section">
      <div class="input-group">
        <input type="text" id="contactId" placeholder="Enter HubSpot Contact ID" />
        <button id="generateBtn" onclick="generateEmails()">Generate Emails</button>
      </div>
    </div>
    
    <div class="error" id="error"></div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Generating personalized emails...</p>
    </div>
    
    <div class="contact-info" id="contactInfo">
      <h3>Contact Information</h3>
      <div class="contact-details">
        <div class="contact-detail">
          <label>Name</label>
          <span id="contactName">-</span>
        </div>
        <div class="contact-detail">
          <label>Email</label>
          <span id="contactEmail">-</span>
        </div>
        <div class="contact-detail">
          <label>Title</label>
          <span id="contactTitle">-</span>
        </div>
        <div class="contact-detail">
          <label>Institution</label>
          <span id="contactInstitution">-</span>
        </div>
        <div class="contact-detail">
          <label>Persona</label>
          <span class="persona-badge" id="contactPersona">-</span>
        </div>
        <div class="contact-detail">
          <label>Pain Point</label>
          <span id="contactPain">-</span>
        </div>
        <div class="contact-detail">
          <label>Email Style</label>
          <span class="style-badge" id="contactStyle">-</span>
        </div>
      </div>
    </div>
    
    <div class="research-section" id="researchSection">
      <h3>üìä IPEDS Research</h3>
      <div id="ipedsContent" class="research-content">No IPEDS data found</div>
    </div>
    
    <div class="prospect-research-section" id="prospectResearchSection">
      <h3>üéØ Prospect Research</h3>
      <div id="prospectContent" class="research-content">No prospect research found</div>
    </div>
    
    <div class="emails-section" id="emailsSection">
      <div class="email-card">
        <div class="email-header">
          <div class="email-number">Email 1 - Initial Outreach (New Thread)</div>
          <div class="email-subject" id="email1Subject">Subject line here</div>
        </div>
        <div class="email-body" id="email1Body"></div>
      </div>
      
      <div class="email-card">
        <div class="email-header">
          <div class="email-number">Email 2 - Follow-up (Reply to #1)</div>
          <div class="email-subject" id="email2Subject">Subject line here</div>
        </div>
        <div class="email-body" id="email2Body"></div>
      </div>
      
      <div class="email-card">
        <div class="email-header">
          <div class="email-number">Email 3 - Value Prop (Reply to #1)</div>
          <div class="email-subject" id="email3Subject">Subject line here</div>
        </div>
        <div class="email-body" id="email3Body"></div>
      </div>
      
      <div class="email-card">
        <div class="email-header">
          <div class="email-number">Email 4 - Fresh Angle (New Thread)</div>
          <div class="email-subject" id="email4Subject">Subject line here</div>
        </div>
        <div class="email-body" id="email4Body"></div>
      </div>
      
      <div class="email-card">
        <div class="email-header">
          <div class="email-number">Email 5 - Closing (Reply to #4)</div>
          <div class="email-subject" id="email5Subject">Subject line here</div>
        </div>
        <div class="email-body" id="email5Body"></div>
      </div>
      
      <div class="note">
        ‚ö†Ô∏è This is a preview only. Emails have NOT been saved to HubSpot.
      </div>
    </div>
  </div>
  
  <script>
    // Allow Enter key to trigger generation
    document.getElementById('contactId').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        generateEmails();
      }
    });
    
    async function generateEmails() {
      const contactId = document.getElementById('contactId').value.trim();
      
      if (!contactId) {
        showError('Please enter a Contact ID');
        return;
      }
      
      // Reset UI
      hideError();
      hideResults();
      showLoading();
      
      try {
        const response = await fetch(`/api/preview?contactId=${contactId}`);
        const data = await response.json();
        
        hideLoading();
        
        if (!response.ok || !data.success) {
          showError(data.error || 'Failed to generate emails');
          return;
        }
        
        // Populate contact info
        document.getElementById('contactName').textContent = data.contact.name || '-';
        document.getElementById('contactEmail').textContent = data.contact.email || '-';
        document.getElementById('contactTitle').textContent = data.contact.title || '-';
        document.getElementById('contactInstitution').textContent = data.contact.institution || '-';
        document.getElementById('contactPersona').textContent = data.analysis.persona || '-';
        document.getElementById('contactPain').textContent = data.analysis.painPoint || '-';
        document.getElementById('contactStyle').textContent = data.analysis.recommendedStyle || '-';
        document.getElementById('contactStyle').title = data.analysis.styleReason || '';
        
        // Populate IPEDS research
        if (data.research && data.research.ipeds) {
          const ipeds = data.research.ipeds;
          const stats = ipeds.stats || {};
          
          let ipedsHtml = `<div><strong>Matched:</strong> ${ipeds.matched} <em>(${ipeds.matchType})</em></div>`;
          ipedsHtml += `<div style="margin-top: 8px;">${ipeds.brief}</div>`;
          
          // Stats boxes
          ipedsHtml += `<div class="research-stats">`;
          ipedsHtml += `<div class="stat-box">
            <div class="stat-value ${stats.overallChange < 0 ? 'negative' : ''}">${stats.overallChange > 0 ? '+' : ''}${stats.overallChange}%</div>
            <div class="stat-label">Since ${stats.earliestYear}</div>
          </div>`;
          ipedsHtml += `<div class="stat-box">
            <div class="stat-value">${stats.latestTotal}</div>
            <div class="stat-label">Completions (${stats.latestYear})</div>
          </div>`;
          ipedsHtml += `<div class="stat-box">
            <div class="stat-value">${stats.programCount}</div>
            <div class="stat-label">Programs</div>
          </div>`;
          ipedsHtml += `</div>`;
          
          // Top programs
          if (stats.topPrograms && stats.topPrograms.length > 0) {
            ipedsHtml += `<div class="program-list"><strong>Top Programs:</strong> `;
            ipedsHtml += stats.topPrograms.slice(0, 5).map(p => {
              const changeClass = p.change > 20 ? 'program-growing' : (p.change < -20 ? 'program-declining' : '');
              const changeText = p.change !== null ? ` (${p.change > 0 ? '+' : ''}${Math.round(p.change)}%)` : '';
              return `<span class="program-item ${changeClass}">${simplifyProgram(p.name)}${changeText}</span>`;
            }).join(' ');
            ipedsHtml += `</div>`;
          }
          
          document.getElementById('ipedsContent').innerHTML = ipedsHtml;
          document.getElementById('researchSection').classList.add('visible');
        } else {
          document.getElementById('researchSection').classList.remove('visible');
        }
        
        // Populate prospect research
        if (data.research && data.research.prospect) {
          const prospectHtml = formatProspectResearch(data.research.prospect);
          document.getElementById('prospectContent').innerHTML = prospectHtml;
          document.getElementById('prospectResearchSection').classList.add('visible');
        } else {
          document.getElementById('prospectResearchSection').classList.remove('visible');
        }
        
        // Populate emails (with defensive checks)
        const emails = data.emails || {};
        
        document.getElementById('email1Subject').textContent = emails.email1?.subject || 'No subject';
        document.getElementById('email1Body').innerHTML = emails.email1?.body || '<p>No body</p>';
        
        document.getElementById('email2Subject').textContent = emails.email2?.subject || 'No subject';
        document.getElementById('email2Body').innerHTML = emails.email2?.body || '<p>No body</p>';
        
        document.getElementById('email3Subject').textContent = emails.email3?.subject || 'No subject';
        document.getElementById('email3Body').innerHTML = emails.email3?.body || '<p>No body</p>';
        
        document.getElementById('email4Subject').textContent = emails.email4?.subject || 'No subject';
        document.getElementById('email4Body').innerHTML = emails.email4?.body || '<p>No body</p>';
        
        document.getElementById('email5Subject').textContent = emails.email5?.subject || 'No subject';
        document.getElementById('email5Body').innerHTML = emails.email5?.body || '<p>No body</p>';
        
        // Show results
        showResults();
        
      } catch (err) {
        hideLoading();
        showError('Network error: ' + err.message);
      }
    }
    
    function showLoading() {
      document.getElementById('loading').classList.add('visible');
      document.getElementById('generateBtn').disabled = true;
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.remove('visible');
      document.getElementById('generateBtn').disabled = false;
    }
    
    function showError(message) {
      const el = document.getElementById('error');
      el.textContent = message;
      el.classList.add('visible');
    }
    
    function hideError() {
      document.getElementById('error').classList.remove('visible');
    }
    
    function showResults() {
      document.getElementById('contactInfo').classList.add('visible');
      document.getElementById('emailsSection').classList.add('visible');
    }
    
    function hideResults() {
      document.getElementById('contactInfo').classList.remove('visible');
      document.getElementById('emailsSection').classList.remove('visible');
      document.getElementById('researchSection').classList.remove('visible');
      document.getElementById('prospectResearchSection').classList.remove('visible');
    }
    
    function formatProspectResearch(text) {
      // Parse the MEDDPICC-style research into sections
      const sections = [];
      
      // Extract key sections
      const roleMatch = text.match(/Role:\s*([^\n]+)/i);
      const championMatch = text.match(/Champion Potential:\s*(\w+)/i);
      const budgetMatch = text.match(/Budget Authority:\s*([^\n]+)/i);
      const painMatch = text.match(/PAIN POINTS:\s*([\s\S]*?)(?=URGENCY|PERSONALIZATION|$)/i);
      const hooksMatch = text.match(/PERSONALIZATION HOOKS:\s*([\s\S]*?)(?=INSTITUTIONAL|CONVERSATION|$)/i);
      const contextMatch = text.match(/INSTITUTIONAL CONTEXT:\s*([\s\S]*?)(?=CONVERSATION|OUTREACH|$)/i);
      const startersMatch = text.match(/CONVERSATION STARTERS:\s*([\s\S]*?)(?=OUTREACH|KEY REFERENCES|$)/i);
      const timingMatch = text.match(/OUTREACH TIMING:\s*([^\n]+)/i);
      
      let html = '<div class="prospect-sections">';
      
      // Role and Champion
      if (roleMatch || championMatch) {
        html += '<div class="prospect-section">';
        if (roleMatch) {
          html += `<span class="prospect-badge badge-medium">${roleMatch[1]}</span>`;
        }
        if (championMatch) {
          const level = championMatch[1].toLowerCase();
          const badgeClass = level === 'high' ? 'badge-high' : (level === 'low' ? 'badge-low' : 'badge-medium');
          html += `<span class="prospect-badge ${badgeClass}">Champion: ${championMatch[1]}</span>`;
        }
        if (budgetMatch) {
          html += `<span class="prospect-badge badge-medium">${budgetMatch[1]}</span>`;
        }
        html += '</div>';
      }
      
      // Pain Points
      if (painMatch && painMatch[1].trim()) {
        html += '<div class="prospect-section">';
        html += '<div class="prospect-section-title">Pain Points</div>';
        html += '<div class="prospect-section-content">' + formatList(painMatch[1]) + '</div>';
        html += '</div>';
      }
      
      // Personalization Hooks
      if (hooksMatch && hooksMatch[1].trim()) {
        html += '<div class="prospect-section">';
        html += '<div class="prospect-section-title">Personalization Hooks</div>';
        html += '<div class="prospect-section-content">' + formatList(hooksMatch[1]) + '</div>';
        html += '</div>';
      }
      
      // Conversation Starters
      if (startersMatch && startersMatch[1].trim()) {
        html += '<div class="prospect-section">';
        html += '<div class="prospect-section-title">Conversation Starters</div>';
        html += '<div class="prospect-section-content">' + formatList(startersMatch[1]) + '</div>';
        html += '</div>';
      }
      
      // Timing
      if (timingMatch) {
        html += '<div class="prospect-section">';
        html += '<div class="prospect-section-title">Best Timing</div>';
        html += '<div class="prospect-section-content">' + timingMatch[1] + '</div>';
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }
    
    function formatList(text) {
      // Convert numbered list to HTML
      const items = text.split(/\d+\.\s+/).filter(item => item.trim());
      if (items.length > 0) {
        return '<ul>' + items.map(item => `<li>${item.trim()}</li>`).join('') + '</ul>';
      }
      return text.trim();
    }
    
    function simplifyProgram(name) {
      return name
        .replace(/, General\.?$/i, '')
        .replace(/BUSINESS, MANAGEMENT, MARKETING, AND RELATED SUPPORT SERVICES/i, 'Business/MBA')
        .replace(/HEALTH PROFESSIONS AND RELATED PROGRAMS/i, 'Health')
        .replace(/COMPUTER AND INFORMATION SCIENCES AND SUPPORT SERVICES/i, 'CS/IT')
        .replace(/COMMUNICATION, JOURNALISM, AND RELATED PROGRAMS/i, 'Communications')
        .replace(/Educational Leadership and Administration/i, 'Ed Leadership')
        .replace(/Business Administration and Management/i, 'MBA')
        .replace(/EDUCATION/i, 'Education')
        .replace(/PSYCHOLOGY/i, 'Psychology');
    }
  </script>
</body>
</html>
